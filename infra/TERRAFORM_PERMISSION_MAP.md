# Terraform Permission Map

Generated by `python3 infra/scripts/check_infra_inventory.py`.
This file is designed for deploy-role policy reviews before sandbox/production builds.

## How To Use

1. Pick your deploy mode (`bootstrap` vs `reuse existing`).
2. Match enabled `create_*` toggles to rows below.
3. Ensure the CI/deploy role has every required action family for enabled rows.
4. Keep unused create flags off to avoid unnecessary privileges and duplicate-resource failures.

## Mode Profiles

- `Sandbox bootstrap`: typically enables `create_networking`, `create_service_security_groups`, `create_alb_resources`, `create_ecs_task_roles`, `create_cloudwatch_log_groups`, `create_data_services`, and `create_efs_resources`.
- `Production reuse`: typically disables most `create_*` flags and provides explicit `existing_*` IDs/ARNs; requires mostly read/discovery + ECS/ECR deploy permissions.

## Module-by-Module AWS API Families

| File | Responsibility | Toggle/Mode | Create/Mutate action families | Reuse/discovery action families | Typical failure signal |
|---|---|---|---|---|---|
| `infra/terraform/alb.tf` | ALB, listeners, listener rules, target groups, and resource discovery for reuse mode. | `create_alb_resources` | `elasticloadbalancing:CreateLoadBalancer/DeleteLoadBalancer/ModifyLoadBalancer, elasticloadbalancing:CreateTargetGroup/DeleteTargetGroup/ModifyTargetGroup/RegisterTargets/DeregisterTargets, elasticloadbalancing:CreateListener/DeleteListener/ModifyListener, elasticloadbalancing:CreateRule/DeleteRule/ModifyRule, elasticloadbalancing:AddTags/RemoveTags.` | `elasticloadbalancing:DescribeLoadBalancers, elasticloadbalancing:DescribeTargetGroups, elasticloadbalancing:DescribeListeners.` | TargetGroup already exists / listener rule conflicts when create flags mismatch existing infra. |
| `infra/terraform/cloudwatch.tf` | CloudWatch log groups for ECS services. | `create_cloudwatch_log_groups` | `logs:CreateLogGroup/DeleteLogGroup/PutRetentionPolicy/TagResource/UntagResource.` | `logs:DescribeLogGroups.` | ResourceAlreadyExistsException for log groups when creation is left on for pre-existing groups. |
| `infra/terraform/ecr.tf` | ECR repositories and lifecycle policies. | `Always managed` | `ecr:CreateRepository/DeleteRepository, ecr:PutLifecyclePolicy/DeleteLifecyclePolicy, ecr:TagResource/UntagResource.` | `ecr:DescribeRepositories, ecr:DescribeImages, ecr:GetLifecyclePolicy, ecr:ListTagsForResource.` | Repository already exists unless imported/state-aligned; push/pull issues if repo policy/permissions missing. |
| `infra/terraform/ecs.tf` | ECS cluster, task definitions, and services for backend/frontend/worker/beat. | `Always managed` | `ecs:CreateCluster/UpdateCluster, ecs:RegisterTaskDefinition/DeregisterTaskDefinition, ecs:CreateService/UpdateService/DeleteService, ecs:TagResource, iam:PassRole.` | `ecs:DescribeClusters, ecs:DescribeServices, ecs:ListServices, ecs:DescribeTaskDefinition.` | Creation of service was not idempotent when service exists outside Terraform state. |
| `infra/terraform/efs.tf` | Shared EFS file system, access point, mount targets, and EFS SG. | `enable_shared_uploads + create_efs_resources` | `elasticfilesystem:CreateFileSystem/DeleteFileSystem, elasticfilesystem:CreateMountTarget/DeleteMountTarget, elasticfilesystem:CreateAccessPoint/DeleteAccessPoint, elasticfilesystem:TagResource/UntagResource, elasticfilesystem:PutLifecycleConfiguration, ec2:CreateSecurityGroup/DeleteSecurityGroup, ec2:AuthorizeSecurityGroupIngress/RevokeSecurityGroupIngress, ec2:AuthorizeSecurityGroupEgress/RevokeSecurityGroupEgress.` | `elasticfilesystem:DescribeFileSystems/DescribeMountTargets/DescribeAccessPoints.` | AccessDenied on elasticfilesystem:TagResource or check failure if shared uploads enabled with no EFS IDs. |
| `infra/terraform/elasticache.tf` | Redis cluster, subnet group, and Redis security group. | `create_data_services` | `elasticache:CreateCacheCluster/DeleteCacheCluster/ModifyCacheCluster, elasticache:CreateCacheSubnetGroup/DeleteCacheSubnetGroup/ModifyCacheSubnetGroup, elasticache:AddTagsToResource/RemoveTagsFromResource, ec2:CreateSecurityGroup/DeleteSecurityGroup + SG rule actions.` | `elasticache:DescribeCacheClusters, elasticache:DescribeCacheSubnetGroups, ec2:DescribeSecurityGroups.` | AccessDenied on ElastiCache create APIs or SG creation. |
| `infra/terraform/iam.tf` | OIDC provider, deploy role policy, ECS task roles and attached inline policies. | `create_github_actions_iam / create_ecs_task_roles / manage_ecs_task_role_policies` | `iam:CreateOpenIDConnectProvider/DeleteOpenIDConnectProvider, iam:CreateRole/DeleteRole, iam:AttachRolePolicy/DetachRolePolicy, iam:PutRolePolicy/DeleteRolePolicy.` | `iam:GetRole, iam:GetOpenIDConnectProvider, iam:ListRolePolicies, iam:ListAttachedRolePolicies, iam:PassRole.` | AccessDenied on CreateRole/CreateOpenIDConnectProvider or check failures for missing existing role ARNs. |
| `infra/terraform/imports.tf` | Initial state imports for existing ECR repositories. | `Always evaluated` | `No creation actions; import reads existing resources into state.` | `ecr:DescribeRepositories.` | Import failures if repo names do not exist or caller cannot read ECR. |
| `infra/terraform/outputs.tf` | Exposes computed IDs/endpoints to operators and automation. | `Always evaluated` | `No AWS API actions in this file.` | `No AWS API actions in this file.` | Output resolution errors when referenced resources are intentionally disabled and not guarded. |
| `infra/terraform/providers.tf` | Provider/backend wiring for S3 state and DynamoDB lock table. | `Always evaluated` | `No resource creation in this file.` | `s3:GetObject/PutObject/ListBucket, dynamodb:GetItem/PutItem/DeleteItem/DescribeTable (state + lock handling).` | Terraform init/state lock failures before planning. |
| `infra/terraform/rds.tf` | Postgres DB, subnet group, and DB security group. | `create_data_services` | `rds:CreateDBInstance/DeleteDBInstance/ModifyDBInstance, rds:CreateDBSubnetGroup/DeleteDBSubnetGroup/ModifyDBSubnetGroup, rds:AddTagsToResource/RemoveTagsFromResource, ec2:CreateSecurityGroup/DeleteSecurityGroup + SG rule actions.` | `rds:DescribeDBInstances, rds:DescribeDBSubnetGroups, ec2:DescribeSecurityGroups.` | AccessDenied for RDS create/modify APIs or check failure when db_password missing in create mode. |
| `infra/terraform/security_groups.tf` | ALB/ECS security groups and ingress/egress rule wiring. | `create_service_security_groups` | `ec2:CreateSecurityGroup/DeleteSecurityGroup, ec2:AuthorizeSecurityGroupIngress/RevokeSecurityGroupIngress, ec2:AuthorizeSecurityGroupEgress/RevokeSecurityGroupEgress, ec2:CreateTags/DeleteTags.` | `ec2:DescribeSecurityGroups.` | InvalidGroup.Duplicate on SG names or AccessDenied on security group create/rule APIs. |
| `infra/terraform/ses.tf` | SES domain identity/DKIM and task-role SES send permissions. | `ses_domain + email_provider + manage_task_role_policies` | `ses:VerifyDomainIdentity, ses:VerifyDomainDkim, iam:PutRolePolicy/DeleteRolePolicy (SES send policy).` | `ses:GetIdentityVerificationAttributes, iam:GetRolePolicy.` | AccessDenied on SES verify APIs or missing IAM rights to attach SES send policy. |
| `infra/terraform/variables.tf` | Input contract and validation checks. | `Always evaluated` | `No AWS API actions.` | `No AWS API actions.` | Plan/input validation errors for missing required values or invalid modes. |
| `infra/terraform/vpc.tf` | VPC/subnets/routes/NAT creation OR discovery of pre-existing network assets. | `create_networking` | `ec2:CreateVpc/DeleteVpc, ec2:CreateSubnet/DeleteSubnet, ec2:CreateRouteTable/CreateRoute/DeleteRouteTable, ec2:CreateInternetGateway/AttachInternetGateway/DeleteInternetGateway/DetachInternetGateway, ec2:AllocateAddress/ReleaseAddress, ec2:CreateNatGateway/DeleteNatGateway, ec2:CreateTags/DeleteTags.` | `ec2:DescribeVpcs, ec2:DescribeSubnets, ec2:DescribeAvailabilityZones, ec2:DescribeRouteTables.` | AccessDenied on CreateVpc/AllocateAddress or check failure for missing existing VPC/subnets. |

## Notes

- These are practical action families for this stack; exact resource-level scoping can be tightened in your IAM policy implementation.
- If Terraform reports `already exists`, either import the resource into state or disable creation and provide `existing_*` inputs.
- If Terraform reports `AccessDenied`, compare the failing API action to this map and add the missing permission for the active mode.
