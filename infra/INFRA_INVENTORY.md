# Infra Inventory and Permissions

Generated by `python3 infra/scripts/check_infra_inventory.py`.
Run with `--check` in CI to fail builds when this inventory drifts.

## Existing Folders

| Folder | What it does | Permission impact |
|---|---|---|
| `infra` | Infrastructure root. Shared docs, ECS templates, Terraform modules, and infra utility scripts. | Documentation + configuration only. |
| `infra/ecs` | Canonical ECS task definition templates for backend/frontend containers. | No direct AWS API calls; consumed by deploy workflows and operator tooling. |
| `infra/scripts` | Automation helpers for infra docs/validation used in CI and local checks. | No direct AWS API calls; gates CI quality. |
| `infra/terraform` | Terraform stack for ECS, ALB, networking, IAM, data services, EFS, SES, and outputs. | Directly drives AWS resource creation/update/reuse based on create_* flags. |
| `infra/terraform/environments` | Environment-specific tfvars profiles (for example, full sandbox bootstrap). | Controls whether CI/Terraform needs create privileges or can reuse existing infra. |

## Terraform Modules

| File | Responsibility | Main Toggle/Mode |
|---|---|---|
| `infra/terraform/alb.tf` | ALB, listeners, listener rules, target groups, and existing-resource discovery. | `create_alb_resources` |
| `infra/terraform/cloudwatch.tf` | CloudWatch log groups for backend/frontend/worker/beat services. | `create_cloudwatch_log_groups` |
| `infra/terraform/ecr.tf` | ECR repositories and lifecycle policies for backend/frontend images. | `Always managed` |
| `infra/terraform/ecs.tf` | ECS cluster, task definitions, services, networking wiring, and runtime env/secrets contract. | `Always managed` |
| `infra/terraform/efs.tf` | Shared uploads EFS filesystem/access point/mount targets and EFS SG wiring. | `enable_shared_uploads + create_efs_resources` |
| `infra/terraform/elasticache.tf` | Redis SG, subnet group, and cluster for queue/cache backing services. | `create_data_services` |
| `infra/terraform/iam.tf` | OIDC, CI role, ECS execution/task roles, and task role policy attachments. | `create_github_actions_iam / create_ecs_task_roles / manage_ecs_task_role_policies` |
| `infra/terraform/imports.tf` | One-time import stanzas for pre-existing ECR repositories. | `Always evaluated` |
| `infra/terraform/outputs.tf` | Deployment outputs used by operators and downstream automation. | `Always evaluated` |
| `infra/terraform/providers.tf` | Provider + backend state configuration and global tagging defaults. | `Always evaluated` |
| `infra/terraform/rds.tf` | Postgres SG/subnet group/DB instance provisioning. | `create_data_services` |
| `infra/terraform/security_groups.tf` | ALB/ECS service security groups and SG-rule wiring with reuse mode. | `create_service_security_groups` |
| `infra/terraform/ses.tf` | SES domain identity + DKIM and ECS task SES send policy. | `ses_domain + email_provider` |
| `infra/terraform/variables.tf` | Terraform input contract, environment toggles, and validation rules. | `Always evaluated` |
| `infra/terraform/vpc.tf` | VPC/subnets/routes/NAT creation or discovery of existing network assets. | `create_networking` |

## AWS IAM Permissions Required by Deploy Role

| Scope | Used for | Required action families |
|---|---|---|
| `Always (Terraform state + service deploy path)` | S3 backend bucket, DynamoDB lock table, ECR image repos, ECS cluster/services/task defs, and read-only discovery APIs. | `s3:GetObject/PutObject/ListBucket, dynamodb:*, ecr:*, ecs:RegisterTaskDefinition/UpdateService/Describe*, ec2:Describe*, elasticloadbalancing:Describe*, logs:Describe*, iam:GetRole/PassRole/GetPolicy*` |
| `create_networking=true` | VPC, subnets, route tables, internet gateway, EIP, NAT gateway. | `ec2:CreateVpc/DeleteVpc/CreateSubnet/DeleteSubnet/CreateRouteTable/CreateRoute/CreateInternetGateway/AttachInternetGateway/AllocateAddress/ReleaseAddress/CreateNatGateway/DeleteNatGateway/CreateTags/DeleteTags + ec2:Describe*` |
| `create_service_security_groups=true` | ALB/ECS security groups and SG rules. | `ec2:CreateSecurityGroup/DeleteSecurityGroup/AuthorizeSecurityGroupIngress/RevokeSecurityGroupIngress/AuthorizeSecurityGroupEgress/RevokeSecurityGroupEgress/CreateTags/DeleteTags + ec2:Describe*` |
| `create_alb_resources=true` | ALB, listeners/listener rules, target groups, target registrations. | `elasticloadbalancing:Create*/Modify*/Delete*/RegisterTargets/DeregisterTargets/AddTags/RemoveTags + elasticloadbalancing:Describe*` |
| `create_cloudwatch_log_groups=true` | Service log groups and retention policy updates. | `logs:CreateLogGroup/DeleteLogGroup/PutRetentionPolicy/TagResource/UntagResource + logs:Describe*` |
| `create_ecs_task_roles=true or manage_ecs_task_role_policies=true` | ECS task execution/task roles and inline/attached policies. | `iam:CreateRole/DeleteRole/AttachRolePolicy/DetachRolePolicy/PutRolePolicy/DeleteRolePolicy/GetRole/PassRole/List*` |
| `create_github_actions_iam=true` | GitHub Actions OIDC provider and deploy role policy. | `iam:CreateOpenIDConnectProvider/DeleteOpenIDConnectProvider/GetOpenIDConnectProvider/CreateRole/DeleteRole/PutRolePolicy` |
| `create_efs_resources=true and enable_shared_uploads=true` | EFS filesystem, access point, mount targets, and EFS SG rules. | `elasticfilesystem:Create*/Delete*/Describe*/TagResource/UntagResource/PutLifecycleConfiguration + ec2:Describe*` |
| `create_data_services=true` | RDS Postgres instance/subnet group/SG and ElastiCache Redis cluster/subnet group/SG. | `rds:Create*/Modify*/Delete*/Describe*/AddTagsToResource/RemoveTagsFromResource + elasticache:Create*/Modify*/Delete*/Describe*/AddTagsToResource/RemoveTagsFromResource + ec2:Describe*` |
| `ses_domain set (non-empty)` | SES domain identity + DKIM resources. | `ses:VerifyDomainIdentity/VerifyDomainDkim (modeled via aws_ses_domain_identity/aws_ses_domain_dkim)` |

## Notes

- If `create_*` flags are `false`, Terraform primarily needs read/discovery permissions plus ECS/ECR deploy permissions.
- If a flag is `true`, ensure the deploy role has corresponding create/update/delete permissions before running `terraform apply`.
- Existing-resource reuse depends on names/tags in Terraform data sources (VPC/subnets/SGs/ALB/target groups/IAM roles).
- For per-module action-level mapping, see `infra/TERRAFORM_PERMISSION_MAP.md`.
